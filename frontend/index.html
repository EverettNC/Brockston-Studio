<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BROCKSTON STUDIO // PROFESSIONAL</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.0/split.min.js"></script>

<style>
  * { box-sizing: border-box; }
  :root {
    --void-black: #000000;
    --panel-black: #080808;
    --neon-orange: #FF5F1F; 
    --theme-cyan: #00B4D8;
    --text-main: #e0e0e0;
    --font-term: 'Menlo', 'Consolas', monospace;
  }
  body {
    margin: 0; height: 100vh; background-color: #111; 
    color: var(--text-main); font-family: var(--font-term);
    overflow: hidden; display: flex; justify-content: center; align-items: center; padding: 15px;
  }
  .studio-container {
    width: 100%; height: 100%; background: var(--void-black);
    border: 2px solid var(--neon-orange);
    display: flex; flex-direction: column;
    box-shadow: 0 0 30px rgba(255, 95, 31, 0.1);
  }
  .header {
    height: 40px; border-bottom: 1px solid var(--neon-orange); display: flex;
    align-items: center; justify-content: space-between; padding: 0 20px;
    background: #020202; font-weight: bold; letter-spacing: 3px;
    color: var(--neon-orange); text-transform: uppercase; flex-shrink: 0;
  }
  .middle-area {
    display: flex; flex: 1; overflow: hidden; height: calc(100% - 190px); 
  }
  .gutter {
    background-color: #111; cursor: col-resize;
    border-left: 1px solid #333; border-right: 1px solid #333;
  }
  .gutter:hover { background-color: var(--neon-orange); }
  .col-tools {
    background: var(--panel-black); display: flex; flex-direction: column; align-items: center; padding-top: 25px; overflow: hidden;
  }
  .tool-icon { font-size: 1.5rem; color: #555; margin-bottom: 35px; cursor: pointer; transition: 0.2s; }
  .tool-icon:hover { color: var(--neon-orange); text-shadow: 0 0 10px var(--neon-orange); }
  .col-files { background: var(--panel-black); padding: 15px; overflow-y: auto; }
  .section-title {
    color: var(--theme-cyan); font-size: 0.75rem; border-bottom: 1px solid #333;
    padding-bottom: 8px; margin-bottom: 15px; letter-spacing: 1px; white-space: nowrap;
  }
  ul { list-style: none; padding: 0; margin: 0; }
  li { padding: 8px 0; cursor: pointer; color: #999; font-size: 0.9rem; display: flex; align-items: center; white-space: nowrap;}
  li:hover { color: white; text-shadow: 0 0 5px white; }
  li i { width: 20px; margin-right: 8px; text-align: center; }
  .col-center {
    background: radial-gradient(circle at center, #1a0500 0%, #000000 90%);
    position: relative; overflow: hidden;
  }
  .family-crest {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 350px; opacity: 0.15; z-index: 0; pointer-events: none; filter: grayscale(20%);
  }
  #code-editor {
    position: relative; z-index: 1; width: 100%; height: 100%;
    background: transparent; border: none; color: #e0e0e0;
    padding: 20px; font-family: var(--font-term); font-size: 0.95rem;
    resize: none; outline: none; line-height: 1.6; display: block; 
  }
  .col-ai { background: var(--panel-black); display: flex; flex-direction: column; }
  .chat-log { flex: 1; overflow-y: auto; padding: 20px; font-size: 0.95rem; line-height: 1.5; }
  .input-area {
    border-top: 1px solid var(--neon-orange); padding: 15px; background: #000;
    display: flex; gap: 10px; align-items: flex-end;
  }
  textarea {
    flex: 1; background: #111; border: 1px solid #333; color: white;
    padding: 12px; font-family: inherit; resize: none; outline: none;
    border-radius: 4px; height: 50px;
  }
  textarea:focus { border-color: var(--neon-orange); }
  button {
    width: 90px; flex-shrink: 0; background: var(--neon-orange); color: #000;
    border: none; height: 50px; font-weight: bold; cursor: pointer; border-radius: 2px;
  }
  button:hover { background: #ff7b47; }
  .terminal-panel {
    height: 150px; border-top: 2px solid var(--neon-orange); background: #000;
    padding: 10px 20px; color: #27c93f; font-size: 0.9rem; overflow-y: auto; flex-shrink: 0;
  }
  .cli-input {
    background: transparent; border: none; color: var(--neon-orange);
    width: 100%; font-family: inherit; font-size: 1rem; outline: none; margin-left: 10px;
  }
</style>
</head>
<body>

<div class="studio-container">
  <div class="header">
    <span>BROCKSTON STUDIO // PROFESSIONAL</span>
    <span style="font-size: 0.8em; color: #555;">HOST: 127.0.0.1</span>
  </div>

  <div class="middle-area">
    <div class="col-tools" id="col-1">
      <i class="fa-solid fa-terminal tool-icon" title="Terminal"></i>
      <i class="fa-solid fa-code-branch tool-icon" title="Git"></i>
      <i class="fa-solid fa-magnifying-glass tool-icon" title="Search"></i>
      <i class="fa-solid fa-gear tool-icon" title="Settings" style="margin-top: auto;"></i>
    </div>

    <div class="col-files" id="col-2">
      <div class="section-title">PROJECT EXPLORER</div>
      <ul id="file-list"><li>[Connecting...]</li></ul>
      
      </div>

    <div class="col-center" id="col-3">
      <img src="/static/family_crest.png" class="family-crest" alt="Family Crest" id="crestImg" onerror="tryNextImage()">
      <textarea id="code-editor" spellcheck="false" placeholder="// Select a file to begin..."></textarea>
    </div>

    <div class="col-ai" id="col-4">
      <div class="section-title" style="padding: 15px 20px 0 20px; margin-bottom: 0; border: none;">ASK BROCKSTON / ULTIMATE_EV</div>
      <div class="chat-log" id="qaLog">
        <div style="color: var(--theme-cyan);">[SYSTEM]: Neural Link Active.</div>
      </div>
      <div class="input-area">
        <textarea id="brockstonInput" placeholder="Enter query..."></textarea>
        <button id="sendBtn">SEND</button>
      </div>
    </div>
  </div>

  <div class="terminal-panel" onclick="document.getElementById('termInput').focus()">
    <div style="color: #666; font-size: 0.8em; margin-bottom: 5px;">SYSTEM TERMINAL</div>
    <div id="termOutput"></div>
    <div style="display: flex;">
      <span style="color: var(--neon-orange);">âžœ</span>
      <input type="text" class="cli-input" id="termInput" autofocus>
    </div>
  </div>
</div>

<script>
    Split(['#col-1', '#col-2', '#col-3', '#col-4'], {
        sizes: [5, 15, 50, 30], minSize: [60, 150, 300, 250], gutterSize: 2, cursor: 'col-resize'
    });

    const img = document.getElementById('crestImg');
    const attempts = ['/static/family_crest.jpg', '/static/family_crest.jpeg', '/static/Family_Crest.jpg'];
    let attemptIdx = 0;
    function tryNextImage() {
        if (attemptIdx < attempts.length) { img.src = attempts[attemptIdx]; attemptIdx++; }
    }

    const fileList = document.getElementById('file-list');
    const codeEditor = document.getElementById('code-editor');
    const qaLog = document.getElementById('qaLog');
    const brockstonInput = document.getElementById('brockstonInput');
    const sendBtn = document.getElementById('sendBtn');
    const termInput = document.getElementById('termInput');
    const termOutput = document.getElementById('termOutput');

    async function loadFiles() {
        try {
            const res = await fetch('/api/files/tree');
            const data = await res.json();
            fileList.innerHTML = ''; 
            if(data.files) {
                data.files.forEach(file => {
                    const li = document.createElement('li');
                    let icon = 'fa-file';
                    if(file.is_dir) icon = 'fa-folder';
                    else if(file.name.endsWith('.py')) icon = 'fa-brands fa-python';
                    li.innerHTML = `<i class="fa-regular ${icon}"></i> ${file.name}`;
                    li.onclick = () => openFile(file.path);
                    fileList.appendChild(li);
                });
            }
        } catch (e) {
            fileList.innerHTML = '<li style="color:red">Backend Offline</li>';
        }
    }

    async function openFile(path) {
        codeEditor.value = "Loading " + path + "...";
        try {
            const res = await fetch(`/api/files/open?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            codeEditor.value = data.content; 
        } catch (e) {
            codeEditor.value = "[ERROR] Could not read file.";
        }
    }
    loadFiles();

    async function sendToBrockston() {
        const text = brockstonInput.value;
        if(!text) return;
        brockstonInput.value = '';
        qaLog.innerHTML += `<div style="margin-top:15px; color:#888;">YOU: ${text}</div>`;
        qaLog.scrollTop = qaLog.scrollHeight;
        
        try {
            const response = await fetch('/api/brockston/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: [{ role: "user", content: text }], model: "brockston" })
            });
            
            if (!response.ok) throw new Error("API Error " + response.status);
            
            const data = await response.json();
            qaLog.innerHTML += `<div style="color: var(--theme-cyan); margin-top:5px;">[BROCKSTON]: ${data.reply}</div>`;
        } catch (e) {
            console.error(e);
            qaLog.innerHTML += `<div style="color: red; margin-top:5px;">[ERROR]: ${e.message}</div>`;
        }
        qaLog.scrollTop = qaLog.scrollHeight;
    }
    sendBtn.addEventListener('click', sendToBrockston);
    brockstonInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendToBrockston(); }
    });

    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/terminal`);
    
    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'output') {
            let raw = msg.data;
            
            // TERMINAL SCRUBBER (FIXED)
            let clean = raw.replace(/\x1B\[[0-9;]*m/g, ''); // Colors
            clean = clean.replace(/\x1B\][0-9];.*?\x07/g, ''); // OSC Codes (The ]7;file garbage)
            clean = clean.replace(/\x1B\[\?[0-9;]*[a-zA-Z]/g, ''); // ZSH Modes
            clean = clean.replace(/%\s*$/, ''); 
            clean = clean.replace(/\n/g, '<br>');
            
            if (clean.trim().length > 0 || clean.includes('<br>')) {
                termOutput.innerHTML += `<span>${clean}</span>`;
                const panel = document.querySelector('.terminal-panel');
                panel.scrollTop = panel.scrollHeight;
            }
        }
    };
    termInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const cmd = termInput.value;
            termInput.value = '';
            ws.send(JSON.stringify({ type: 'input', data: cmd + '\n' }));
        }
    });
</script>
</body>
</html>
